---
const { api } = Astro.locals;

const errors = { name: "", password: "" };

if (Astro.request.method === "POST") {
  try {
    const data = await Astro.request.formData();
    const name = data.get("username") ?? "";
    const password = data.get("password") ?? "";
    const passwordConfirm = data.get("confirmPassword");
    if (typeof name !== "string") {
      errors.name = "Invalid username.";
    }
    if (
      typeof password !== "string" ||
      password !== passwordConfirm ||
      password.length < 8
    ) {
      errors.password = "Passwords must match and be at least 8 characters";
    }
    if (errors.password === "") {
      await api
        .collection("users")
        .create({ username: name, password, passwordConfirm });
      const authData = await api
        .collection("users")
        .authWithPassword(name.toString(), password.toString());
      if (authData) {
        document.cookie = `token=${authData.token};`;
        location.reload();
      }
    }
    // Do something with the data
  } catch (error) {
    if (error instanceof Error) {
      console.error(error.message);
    }
  }
}
---

<div class="m-auto flex flex-col gap-6">
  <form method="post" class="flex flex-col gap-y-3">
    <div class="font-semibold text-lg">Create account</div>
    <label class="flex flex-col">
      <div class="font-light text-sm">Name:</div>
      <input
        type="text"
        name="username"
        class="rounded-md px-2"
        placeholder="name"
        required
      />
    </label>
    <label class="flex flex-col">
      <div class="font-light text-sm">Password:</div>
      <input
        type="password"
        name="password"
        class="rounded-md px-2"
        placeholder="password"
        required
      />
    </label>
    <label class="flex flex-col">
      <div class="font-light text-sm">Confirm password:</div>
      <input
        type="password"
        name="confirmPassword"
        class="rounded-md px-2"
        placeholder="confirm password"
        required
      />
    </label>
    <div class="mx-auto">
      <button class="rounded-md bg-offset p-2 hover:text-offset"
        >Create account</button>
    </div>
  </form>
</div>
